---
depends_on: []
kind: pipeline
name: ci
services:
- image: docker:dind
  name: docker
  privileged: true
  volumes:
  - name: dockersock
    path: /var/run
steps:
- commands:
  - make test
  image: golang
  name: test
- commands:
  - make test-e2e
  image: reg.dist.svc.cluster.znet:5000/zachfi/build-image
  name: test-e2e
  pull: always
  volumes:
  - name: dockersock
    path: /var/run
- commands:
  - sudo make docker-build registry=reg.dist.svc.cluster.znet:5000
  image: reg.dist.svc.cluster.znet:5000/zachfi/build-image
  name: build-image
  volumes:
  - name: dockersock
    path: /var/run
  when:
    ref:
    - refs/heads/main
- commands:
  - sudo make docker-push registry=reg.dist.svc.cluster.znet:5000
  environment:
    DOCKER_PASSWORD:
      from_secret: DOCKER_PASSWORD
    DOCKER_USERNAME:
      from_secret: DOCKER_USERNAME
  image: reg.dist.svc.cluster.znet:5000/zachfi/build-image
  name: push-image
  volumes:
  - name: dockersock
    path: /var/run
  when:
    ref:
    - refs/heads/main
trigger:
  ref:
  - refs/heads/main
  - refs/heads/dependabot/**
  - refs/pull/*/head
volumes:
- host:
    path: /var/run/docker.sock
  name: dockersock
---
depends_on: []
kind: pipeline
name: release
steps:
- commands:
  - make release
  environment:
    GITHUB_TOKEN:
      from_secret: GITHUB_TOKEN
  image: reg.dist.svc.cluster.znet:5000/zachfi/build-image
  name: release
  pull: always
  when:
    ref:
    - refs/tags/v*
trigger:
  ref:
  - refs/tags/v*
volumes:
- host:
    path: /var/run/docker.sock
  name: dockersock
---
kind: signature
hmac: ee1ba251e5abdf8599b02ecd129b599a599c6c2e52d691d48131aa8405cedfa1

...
